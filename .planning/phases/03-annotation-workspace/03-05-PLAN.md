---
phase: 03-annotation-workspace
plan: 05
type: execute
wave: 5
depends_on: [03-04]
files_modified: []
autonomous: false
requirements: [VID-03, VID-04, ANN-01, ANN-02, ANN-03, ANN-04, ANN-05]

must_haves:
  truths:
    - "Coach can scrub video frame-by-frame using arrow keys and view each frame clearly"
    - "Speed controls (0.25x, 0.5x, 1x) change video playback speed visibly"
    - "Clicking a paused frame activates annotation mode and shows the floating toolbar"
    - "Coach can draw freehand strokes on the frozen frame in at least four colors"
    - "Coach can draw straight lines and arrows on the frozen frame"
    - "Coach can place an angle measurement with three clicks and see the degree label"
    - "Coach can add a text label to the frozen frame"
    - "Annotations persist across page reloads — reopening the video shows saved annotations"
    - "Annotations replay in sync as video plays or scrubs"
    - "Annotation markers (blue dots) appear on the timeline for annotated frames"
    - "AI skeleton overlay stays visible in annotation mode and can be toggled"
    - "Escape exits annotation mode without losing annotations"
    - "Undo (Cmd+Z / Ctrl+Z) removes the last shape from the current frame"
  artifacts:
    - path: "src/components/review/ReviewPageClient.tsx"
      provides: "Complete annotation workspace"
    - path: "src/components/review/AnnotationCanvas.tsx"
      provides: "Interactive drawing canvas"
    - path: "src/components/review/AnnotationToolbar.tsx"
      provides: "Floating annotation toolbar"
    - path: "src/hooks/useAnnotations.ts"
      provides: "Annotation persistence hook"
    - path: "src/app/api/annotations/route.ts"
      provides: "Annotation API endpoints"
    - path: "supabase/migrations/006_video_annotations.sql"
      provides: "Annotation database schema"
  key_links:
    - from: "Coach browser (/review/[videoId])"
      to: "annotation workspace"
      via: "clicking paused video frame"
      pattern: "annotation.*mode"
---

<objective>
End-to-end verification of the complete Phase 3 Annotation Workspace feature: frame stepping, slow motion, freeze-to-annotate, all drawing tools, angle measurement, text labels, annotation persistence, playback sync, timeline markers, and skeleton coexistence.

Purpose: Confirms that all Phase 3 success criteria function correctly in the running application from a coach's perspective. This is the final gate before Phase 3 is marked complete.
Output: Human verification of all Phase 3 success criteria (VID-03, VID-04, ANN-01–ANN-05).
</objective>

<execution_context>
@/Users/abhishekhodavdekar/.claude/get-shit-done/workflows/execute-plan.md
@/Users/abhishekhodavdekar/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/03-annotation-workspace/03-CONTEXT.md
@.planning/phases/03-annotation-workspace/03-04-SUMMARY.md
</context>

<tasks>

<task type="checkpoint:human-verify" gate="blocking">
  <name>End-to-end Phase 3 verification: frame stepping, slow motion, annotation tools, persistence, and playback sync</name>
  <action>Human verification — no automated implementation in this task. All code was built in Plans 01–04.</action>
  <verify>See how-to-verify instructions below</verify>
  <done>Coach confirms: frame stepping works, speed controls work, annotation mode activates on click, all five tools work (freehand, line, arrow, angle, text), annotations persist across reload, annotations replay in sync during playback, timeline shows blue annotation markers, AI skeleton visible in annotation mode</done>
  <what-built>
    Complete Phase 3 Annotation Workspace:
    - Supabase video_annotations table with RLS (migration 006)
    - TypeScript type contracts: AnnotationShape union, AnnotationFrame, AnnotationColor (src/types/annotation.ts)
    - Geometry utilities: computeAngleDeg, findNearestAnnotatedFrame (src/lib/annotation/geometry.ts)
    - useAnnotations hook: loads all annotation frames on mount, upserts on saveFrame (src/hooks/useAnnotations.ts)
    - GET + PUT /api/annotations API route with auth (src/app/api/annotations/route.ts)
    - AnnotationCanvas: react-konva Stage with freehand, line, arrow, angle (three-click), text tools; undo/redo; two-finger pan/zoom (src/components/review/AnnotationCanvas.tsx)
    - AnnotationToolbar: floating toolbar with tools + color picker (six colors, four required) + clear frame (src/components/review/AnnotationToolbar.tsx)
    - VideoWithOverlay: custom control bar (play/pause, frame step, 0.25x/0.5x/1x speed), swipe gesture, requestVideoFrameCallback frame detection (src/components/review/VideoWithOverlay.tsx)
    - AnalysisTimeline: blue annotation frame markers alongside existing AI markers (src/components/review/AnalysisTimeline.tsx)
    - ReviewPageClient: annotation state machine (playback ↔ annotating), shape auto-save (debounced 500ms), Escape/click-outside exit, annotation replay sync during playback (src/components/review/ReviewPageClient.tsx)
  </what-built>
  <how-to-verify>
    **Pre-flight:** Ensure Supabase migration 006 has been applied (`npx supabase db push` or Dashboard SQL editor).

    **Run:** `npm run dev`

    **Navigate to a ready video:** Log in as coach → dashboard → click "Review" on a ready video.

    ---

    **Flow 1: Frame-by-frame stepping (VID-03)**
    1. Let the video load and pause it
    2. Press the right arrow key (→)
    3. EXPECTED: Video advances by approximately one frame (visually different frame appears)
    4. Press left arrow key (←)
    5. EXPECTED: Video steps back one frame
    6. On iPad: swipe left on the paused video
    7. EXPECTED: Video advances one frame (swipe left = forward, swipe right = backward)
    NOTE: Annotation workspace is not available on phones — verify on desktop or iPad only

    **Flow 2: Slow motion playback (VID-04)**
    8. Find the speed control buttons in the player bar (0.25x, 0.5x, 1x)
    9. EXPECTED: Speed buttons are always visible (not hidden)
    10. Click "0.25x"
    11. EXPECTED: Active button highlights (blue); video plays at visibly slower speed when you press play
    12. Click "0.5x" and play
    13. EXPECTED: Faster than 0.25x but still slow motion
    14. Click "1x" to return to normal speed

    **Flow 3: Annotation mode entry (ANN-01)**
    15. Pause the video at any frame (click the play/pause button or press Space)
    16. Click anywhere on the video/canvas area
    17. EXPECTED: A floating toolbar appears on the left side of the canvas with tool icons and color swatches
    18. EXPECTED: No separate "Annotate" button was needed — clicking the paused frame activated it automatically

    **Flow 4: Freehand drawing and color selection (ANN-01, ANN-04)**
    19. In annotation mode, ensure "Freehand" tool is selected (pencil icon)
    20. Draw a stroke across the video frame
    21. EXPECTED: A freehand line appears in the current color
    22. Click the red color swatch — draw another stroke
    23. EXPECTED: New stroke appears in red
    24. Click green, yellow, white in turn — draw a stroke each
    25. EXPECTED: All four required colors work
    26. EXPECTED: AI skeleton overlay is still visible behind the annotations

    **Flow 5: Line and arrow tools (ANN-01)**
    27. Select the line tool (dash icon) — click and drag
    28. EXPECTED: A straight line drawn from drag start to end
    29. Select the arrow tool — click and drag
    30. EXPECTED: Arrow with arrowhead at the drag endpoint

    **Flow 6: Angle measurement (ANN-02)**
    31. Select the angle tool (triangle icon)
    32. Click once on the video — this sets the vertex (apex point)
    33. Click a second point — this sets arm 1
    34. Click a third point — this sets arm 2
    35. EXPECTED: Two lines drawn from the vertex to both arm points; an arc at the vertex; a degree label (e.g. "47°") displayed near the arc
    36. EXPECTED: The angle value is correct for the three points selected

    **Flow 7: Text label (ANN-03)**
    37. Select the text tool (T icon)
    38. Click on the video frame
    39. EXPECTED: A text input appears at the click location
    40. Type "Hip rotation" and press Enter (or click away)
    41. EXPECTED: The text label "Hip rotation" appears on the canvas at the clicked position

    **Flow 8: Undo/redo**
    42. Press Cmd+Z (Mac) or Ctrl+Z (Windows) while in annotation mode
    43. EXPECTED: The last shape added is removed from the canvas
    44. Press Cmd+Shift+Z / Ctrl+Shift+Z
    45. EXPECTED: The removed shape reappears (redo)

    **Flow 9: Exit annotation mode (CONTEXT.md decisions)**
    46. Press Escape
    47. EXPECTED: Toolbar disappears; video stays paused; shapes remain on screen (read-only)
    48. Click outside the video area (e.g., the sidebar)
    49. EXPECTED: Same result — toolbar disappears, video stays paused
    50. Press Play
    51. EXPECTED: Annotation mode exits; video plays; annotations still visible overlaid on the video

    **Flow 10: Annotation persistence (ANN-05)**
    52. While in annotation mode, add at least two shapes (e.g., a freehand stroke and a text label)
    53. Exit annotation mode (Escape or play)
    54. Wait 1 second for auto-save
    55. Refresh the browser page (Cmd+R / F5)
    56. Navigate back to the same /review/[videoId] URL
    57. Scrub to the annotated frame timestamp
    58. EXPECTED: The shapes drawn before refresh reappear on the canvas — annotations persisted to Supabase

    **Flow 11: Annotation replay sync during playback (ANN-05)**
    59. With annotations saved (from Flow 10), play the video from before the annotated frame
    60. EXPECTED: As video plays through the annotated timestamp, the shapes appear overlaid (within ~100ms)
    61. EXPECTED: Video does NOT auto-pause at the annotated frame — it plays through
    62. Scrub to the annotated frame manually
    63. EXPECTED: Shapes appear immediately on canvas

    **Flow 12: Timeline annotation markers**
    64. Look at the timeline scrubber below the video
    65. EXPECTED: Blue dot markers appear at the positions of annotated frames
    66. EXPECTED: These are visually distinct from the red/yellow AI flag markers
    67. Click a blue annotation marker
    68. EXPECTED: Video seeks to that frame; shapes appear on canvas

    **Flow 13: Skeleton coexistence in annotation mode (CONTEXT.md decision)**
    69. Enter annotation mode (click paused frame)
    70. EXPECTED: AI pose skeleton overlay is still visible (not hidden when annotation mode activates)
    71. Draw a shape over the skeleton
    72. EXPECTED: Both skeleton and annotation shapes visible simultaneously
    73. Toggle the skeleton off using the sidebar toggle
    74. EXPECTED: Skeleton hides; annotation shapes still visible
    75. Toggle skeleton back on — EXPECTED: skeleton reappears with annotation shapes

    **Acceptable partial passes:**
    - If the test video has no detectable pose, the skeleton may not appear — annotation tools should still work on all frames
    - Frame step precision may vary (±1 frame) depending on video frame rate — approximate is acceptable for coaching review
    - On desktop browsers that do not support requestVideoFrameCallback (unlikely in 2026), frame step defaults to 1/30s
  </how-to-verify>
  <resume-signal>
    Type "approved" if Flows 1–13 all pass (minor cosmetic issues acceptable).
    Or describe specific issues: which flow failed, what you saw vs. expected.
  </resume-signal>
</task>

</tasks>

<verification>
All Phase 3 success criteria from ROADMAP.md verified by coach:
1. VID-03: Frame-by-frame stepping via arrow keys (desktop) and swipe (mobile)
2. VID-04: Slow motion playback at 0.25x and 0.5x via speed buttons
3. ANN-01: Coach can freeze a frame and draw freehand strokes, straight lines, and arrows
4. ANN-02: Angle measurement tool (three-point click) shows degree label on canvas
5. ANN-03: Text label tool places text at clicked position
6. ANN-04: At least four colors (red, green, yellow, white) available in toolbar
7. ANN-05: Annotations save to Supabase and persist across page reload; replay in sync during playback
8. Timeline shows blue annotation frame markers
9. AI skeleton coexists with annotations in annotation mode
10. Undo/redo works (Cmd+Z / Cmd+Shift+Z)
</verification>

<success_criteria>
Phase 3 is complete when:
1. Coach confirms frame-by-frame stepping and slow motion speed controls work
2. Coach confirms clicking a paused frame enters annotation mode automatically
3. Coach confirms all five tools work (freehand, line, arrow, angle, text)
4. Coach confirms at least four colors selectable from the toolbar
5. Coach confirms annotations persist across page reload
6. Coach confirms annotations overlay in sync during video playback
7. Coach confirms blue annotation markers appear on the timeline
8. Coach confirms AI skeleton remains visible in annotation mode
9. Coach confirms Escape exits annotation mode without losing shapes
10. Coach confirms undo (Cmd+Z) removes the last shape
</success_criteria>

<output>
After completion, create `.planning/phases/03-annotation-workspace/03-05-SUMMARY.md`
</output>
