---
phase: 03-annotation-workspace
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/006_video_annotations.sql
  - src/types/annotation.ts
  - src/lib/annotation/geometry.ts
autonomous: true
requirements: [VID-03, VID-04, ANN-01, ANN-02, ANN-03, ANN-04, ANN-05]

must_haves:
  truths:
    - "video_annotations table exists in Supabase with UNIQUE(video_id, frame_timestamp_ms) and all four RLS policies"
    - "TypeScript discriminated union AnnotationShape exports FreehandShape, LineShape, ArrowShape, AngleShape, TextShape"
    - "AnnotationFrame and AnnotationToolType types exported from src/types/annotation.ts"
    - "computeAngleDeg pure function exported from src/lib/annotation/geometry.ts"
    - "npx tsc --noEmit exits 0"
  artifacts:
    - path: "supabase/migrations/006_video_annotations.sql"
      provides: "video_annotations schema + RLS"
      contains: "CREATE TABLE video_annotations"
    - path: "src/types/annotation.ts"
      provides: "AnnotationShape union, AnnotationFrame, AnnotationToolType, AnnotationColor"
      exports: ["AnnotationShape", "AnnotationFrame", "AnnotationToolType", "AnnotationColor", "FreehandShape", "LineShape", "ArrowShape", "AngleShape", "TextShape"]
    - path: "src/lib/annotation/geometry.ts"
      provides: "computeAngleDeg(vertex, arm1, arm2) pure function"
      exports: ["computeAngleDeg"]
  key_links:
    - from: "src/types/annotation.ts"
      to: "all Phase 3 components and hooks"
      via: "TypeScript imports"
      pattern: "export.*AnnotationShape"
    - from: "supabase/migrations/006_video_annotations.sql"
      to: "useAnnotations hook (Plan 02)"
      via: "video_annotations table"
      pattern: "video_annotations"
---

<objective>
Create the database schema for annotation persistence and TypeScript type contracts so all downstream Phase 3 plans have a shared foundation to build on.

Purpose: Plans 02–04 all import from src/types/annotation.ts and write to the video_annotations table. This plan must complete first.
Output: Migration SQL, TypeScript type file, geometry utility.
</objective>

<execution_context>
@/Users/abhishekhodavdekar/.claude/get-shit-done/workflows/execute-plan.md
@/Users/abhishekhodavdekar/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/03-annotation-workspace/03-RESEARCH.md
@.planning/phases/02-ai-pose-analysis/02-06-SUMMARY.md

<interfaces>
<!-- Migration numbering: 001–005 exist; next is 006 -->
<!-- RLS pattern from existing migrations: -->
<!-- ALTER TABLE x ENABLE ROW LEVEL SECURITY -->
<!-- CREATE POLICY "name" ON x FOR SELECT USING (video_id IN (SELECT id FROM videos WHERE coach_id = auth.uid())) -->

<!-- Supabase upsert pattern for annotations (from RESEARCH.md Pattern 10): -->
<!-- upsert({ video_id, frame_timestamp_ms, shapes }, { onConflict: 'video_id,frame_timestamp_ms' }) -->
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Supabase migration — video_annotations table</name>
  <files>supabase/migrations/006_video_annotations.sql</files>
  <action>
Create `supabase/migrations/006_video_annotations.sql` with the following exact schema (from RESEARCH.md Pattern 10):

```sql
-- Migration 006: video_annotations
-- One row per (video_id, frame_timestamp_ms).
-- Shapes stored as JSONB array. Normalized coordinates (0-1) stored inside each shape object.
CREATE TABLE video_annotations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  video_id UUID NOT NULL REFERENCES videos(id) ON DELETE CASCADE,
  frame_timestamp_ms INTEGER NOT NULL,
  shapes JSONB NOT NULL DEFAULT '[]',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(video_id, frame_timestamp_ms)
);

CREATE INDEX idx_va_video_id ON video_annotations(video_id);
CREATE INDEX idx_va_video_ts ON video_annotations(video_id, frame_timestamp_ms);

ALTER TABLE video_annotations ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Coaches can read own video annotations"
  ON video_annotations FOR SELECT
  USING (video_id IN (SELECT id FROM videos WHERE coach_id = auth.uid()));

CREATE POLICY "Coaches can insert own video annotations"
  ON video_annotations FOR INSERT
  WITH CHECK (video_id IN (SELECT id FROM videos WHERE coach_id = auth.uid()));

CREATE POLICY "Coaches can update own video annotations"
  ON video_annotations FOR UPDATE
  USING (video_id IN (SELECT id FROM videos WHERE coach_id = auth.uid()));

CREATE POLICY "Coaches can delete own video annotations"
  ON video_annotations FOR DELETE
  USING (video_id IN (SELECT id FROM videos WHERE coach_id = auth.uid()));
```

Apply via `npx supabase db push` or paste into the Supabase Dashboard SQL editor.
  </action>
  <verify>
    <automated>npx supabase db push --dry-run 2>&1 | grep -E "(error|Error|Success|up to date)" || echo "Check migration file syntax manually if supabase CLI not configured"</automated>
  </verify>
  <done>Migration file exists at supabase/migrations/006_video_annotations.sql. Table defined with UNIQUE(video_id, frame_timestamp_ms), two indexes, RLS enabled, four policies (SELECT/INSERT/UPDATE/DELETE) all scoped to coach_id = auth.uid().</done>
</task>

<task type="auto">
  <name>Task 2: TypeScript type contracts + geometry utility</name>
  <files>
    src/types/annotation.ts
    src/lib/annotation/geometry.ts
  </files>
  <action>
**Part A: Create src/types/annotation.ts**

All coordinates are normalized 0–1. Multiply by canvas display width/height when rendering. This avoids cross-device coordinate drift.

```typescript
// src/types/annotation.ts
// Type contracts for Phase 3 annotation workspace.
// All coordinates normalized 0–1 (multiply by canvas dimensions on render).
// All downstream components and hooks import from here.

export type AnnotationToolType = 'freehand' | 'line' | 'arrow' | 'angle' | 'text'

// Minimum four colors per ANN-04. Additional colors at Claude's discretion.
export type AnnotationColor = 'red' | 'green' | 'yellow' | 'white' | 'blue' | 'orange'

export interface FreehandShape {
  type: 'freehand'
  id: string
  // Flat array [x1,y1,x2,y2,...], each value normalized 0–1
  points: number[]
  color: AnnotationColor
  strokeWidth: number
}

export interface LineShape {
  type: 'line'
  id: string
  // [x1,y1,x2,y2] normalized 0–1
  points: [number, number, number, number]
  color: AnnotationColor
  strokeWidth: number
}

export interface ArrowShape {
  type: 'arrow'
  id: string
  // [x1,y1,x2,y2] normalized 0–1
  points: [number, number, number, number]
  color: AnnotationColor
  strokeWidth: number
}

export interface AngleShape {
  type: 'angle'
  id: string
  vertex: [number, number]  // normalized 0–1
  arm1: [number, number]    // normalized 0–1
  arm2: [number, number]    // normalized 0–1
  angleDeg: number          // computed and stored for display
  color: AnnotationColor
}

export interface TextShape {
  type: 'text'
  id: string
  position: [number, number]  // normalized 0–1
  text: string
  color: AnnotationColor
  fontSize: number
}

export type AnnotationShape =
  | FreehandShape
  | LineShape
  | ArrowShape
  | AngleShape
  | TextShape

export interface AnnotationFrame {
  videoId: string
  frameTimestampMs: number
  shapes: AnnotationShape[]
}
```

**Part B: Create src/lib/annotation/geometry.ts**

Create the `src/lib/annotation/` directory if it does not exist. Then create `geometry.ts`:

```typescript
// src/lib/annotation/geometry.ts
// Pure geometry utilities for annotation tools.
// No React or DOM dependencies — safe to import anywhere.

/**
 * Compute the angle in degrees formed at `vertex` between rays to `arm1` and `arm2`.
 * All coordinates are in any consistent unit (normalized or pixel — caller's choice).
 * Returns 0 if either arm has zero length.
 */
export function computeAngleDeg(
  vertex: [number, number],
  arm1: [number, number],
  arm2: [number, number]
): number {
  const v1 = [arm1[0] - vertex[0], arm1[1] - vertex[1]]
  const v2 = [arm2[0] - vertex[0], arm2[1] - vertex[1]]
  const dot = v1[0] * v2[0] + v1[1] * v2[1]
  const mag1 = Math.sqrt(v1[0] ** 2 + v1[1] ** 2)
  const mag2 = Math.sqrt(v2[0] ** 2 + v2[1] ** 2)
  if (mag1 === 0 || mag2 === 0) return 0
  // Clamp dot/mag product to [-1, 1] to guard against floating-point rounding past acos domain
  return Math.round(Math.acos(Math.max(-1, Math.min(1, dot / (mag1 * mag2)))) * (180 / Math.PI))
}

/**
 * Find the nearest frame timestamp (in ms) in an annotationsMap within a tolerance window.
 * Returns null if no annotated frame is within toleranceMs of timMs.
 */
export function findNearestAnnotatedFrame(
  annotationsMap: Map<number, unknown>,
  timMs: number,
  toleranceMs: number
): number | null {
  let nearest: number | null = null
  let minDiff = Infinity
  for (const ts of annotationsMap.keys()) {
    const diff = Math.abs(ts - timMs)
    if (diff < minDiff && diff <= toleranceMs) {
      minDiff = diff
      nearest = ts
    }
  }
  return nearest
}
```
  </action>
  <verify>
    <automated>npx tsc --noEmit 2>&1 | head -20</automated>
  </verify>
  <done>
    - src/types/annotation.ts exports: AnnotationToolType, AnnotationColor, FreehandShape, LineShape, ArrowShape, AngleShape, TextShape, AnnotationShape, AnnotationFrame
    - AnnotationColor includes 'red', 'green', 'yellow', 'white' (minimum per ANN-04) plus 'blue' and 'orange'
    - src/lib/annotation/geometry.ts exports computeAngleDeg and findNearestAnnotatedFrame as pure functions with no DOM dependencies
    - npx tsc --noEmit exits 0
  </done>
</task>

</tasks>

<verification>
- supabase/migrations/006_video_annotations.sql defines video_annotations with UNIQUE(video_id, frame_timestamp_ms), idx_va_video_id index, idx_va_video_ts index, RLS enabled, four policies
- src/types/annotation.ts exports AnnotationShape union type (discriminated by `type` field)
- src/types/annotation.ts exports AnnotationColor with at minimum 'red' | 'green' | 'yellow' | 'white'
- src/lib/annotation/geometry.ts exports computeAngleDeg(vertex, arm1, arm2): number
- src/lib/annotation/geometry.ts exports findNearestAnnotatedFrame(map, timMs, toleranceMs): number | null
- npx tsc --noEmit exits 0
</verification>

<success_criteria>
After Phase 3 Plan 01:
1. supabase/migrations/006_video_annotations.sql defines video_annotations with correct schema, unique constraint, indexes, and RLS
2. src/types/annotation.ts defines all TypeScript contracts needed by Plans 02–04
3. src/lib/annotation/geometry.ts provides computeAngleDeg and findNearestAnnotatedFrame as pure functions
4. TypeScript compiles clean
</success_criteria>

<output>
After completion, create `.planning/phases/03-annotation-workspace/03-01-SUMMARY.md`
</output>
