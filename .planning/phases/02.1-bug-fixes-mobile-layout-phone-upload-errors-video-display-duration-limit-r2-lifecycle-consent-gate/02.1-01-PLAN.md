---
phase: "02.1"
plan: "02.1-01"
title: "Bug fixes: mobile layout, phone uploads, video display, duration limit, R2 lifecycle, consent"
status: complete
completed: "2026-02-28"
wave: 1
---

# Phase 02.1 Plan: Production Bug Fixes

## Goal
Fix six production issues discovered after Phase 2 before beginning Phase 3.

## Fixes Delivered

### 1. Mobile / iPad Layout
- Nav uses `flex-wrap` so links wrap on small screens
- Review page stacks video + sidebar vertically on mobile (`flex-col lg:flex-row`)
- MechanicsSidebar goes full-width with top border on mobile
- Dashboard `SessionRow` restructured: thumbnail left, name/date/status/button stacked in `flex-col` on right — no more content squeeze

### 2. FFmpeg "No such file" on Phone Uploads
- Root cause: Inngest steps run on separate Lambda instances; `/tmp` file from step 1 may not exist in step 2
- Fix: `transcode-to-hls` and `extract-thumbnail` steps check `existsSync` and re-download from R2 if file is missing

### 3. Video Aspect Ratio + Skeleton Overlay
- FFmpeg scale changed from `scale=1280:720` (forced landscape) to `scale=-2:720` (preserves aspect ratio)
- `VideoWithOverlay` now uses `object-contain` on video + black container
- Added `computeVideoRenderRect()` to calculate letterbox/pillarbox offset
- `drawSkeleton()` accepts optional `renderRect` so landmarks map to actual video content area

### 4. 5-Second Duration Limit
- `getVideoDuration()` reads metadata before upload via temporary `<video>` element
- Added 4s timeout to prevent hang on iPhone HEVC/MOV formats that never fire `onloadedmetadata`
- Videos > 5s rejected with clear error message before presign request

### 5. R2 Lifecycle Policy (7-day expiry on raw uploads)
- `scripts/set-r2-lifecycle.ts` — one-time script to set `raw/` prefix expiration
- `npm run set-r2-lifecycle` to apply
- Rule ID: `expire-raw-videos-7d`

### 6. Legal Consent Gate
- Consent checkbox in `UploadPageClient` gates the upload zone
- Must be checked before file picker / drop zone appears
- Covers athlete video recording, storage, and analysis consent

## Commits
- `7b3b300` fix(ux): responsive mobile layout for nav and review page
- `f3b8da6` fix(transcode): guard /tmp between Inngest steps + preserve video aspect ratio
- `8aaa91b` fix(review): correct skeleton overlay alignment for portrait and pillarboxed videos
- `3dd4da3` fix(upload): reject videos longer than 5 seconds before upload
- `834d309` feat(infra): add R2 lifecycle policy to expire raw videos after 14 days
- `74dcd52` feat(upload): require legal consent acceptance before enabling video upload
- `61dfdc6` fix(upload): add timeout to video duration check to unblock iPhone uploads
- `2c59579` fix(infra): reduce raw video lifecycle expiry from 14 days to 7 days
- `ebb929a` fix(dashboard): fix SessionRow layout on mobile
