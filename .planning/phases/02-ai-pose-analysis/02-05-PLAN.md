---
phase: 02-ai-pose-analysis
plan: 05
type: execute
wave: 3
depends_on: [02-02, 02-03, 02-04]
files_modified:
  - src/components/review/MechanicsSidebar.tsx
  - src/app/(app)/review/[videoId]/page.tsx
autonomous: true
requirements: [AI-01, AI-02, AI-03]

must_haves:
  truths:
    - "Coach can navigate to /review/[videoId] and see the video with skeleton overlay"
    - "Sidebar shows hip rotation, elbow slot, and shoulder tilt values that update as the video plays"
    - "Sidebar shows the active flag (issue + confidence %) when a flagged frame is visible"
    - "Sidebar has Prev / Next flag navigation buttons"
    - "Skeleton toggle button hides/shows the canvas overlay"
    - "If analysis is in progress, a progress bar shows 'Analyzing... 60%'"
    - "If framing warning exists, it appears as a yellow callout in the sidebar"
    - "Re-analyze button appears and is disabled while analyzing"
  artifacts:
    - path: "src/components/review/MechanicsSidebar.tsx"
      provides: "Joint angles display + flag panel + Prev/Next navigation + toggle + Re-analyze button"
      exports: ["MechanicsSidebar"]
    - path: "src/app/(app)/review/[videoId]/page.tsx"
      provides: "Review workspace page wiring everything together"
      exports: ["default (ReviewPage)"]
  key_links:
    - from: "src/app/(app)/review/[videoId]/page.tsx"
      to: "src/hooks/usePoseAnalysis.ts"
      via: "usePoseAnalysis(videoId, videoRef)"
      pattern: "usePoseAnalysis"
    - from: "src/app/(app)/review/[videoId]/page.tsx"
      to: "src/components/review/VideoWithOverlay.tsx"
      via: "<VideoWithOverlay hlsUrl frames showSkeleton />"
      pattern: "VideoWithOverlay"
    - from: "src/app/(app)/review/[videoId]/page.tsx"
      to: "src/components/review/MechanicsSidebar.tsx"
      via: "<MechanicsSidebar currentFrame angles flags />"
      pattern: "MechanicsSidebar"
    - from: "src/app/(app)/review/[videoId]/page.tsx"
      to: "src/components/review/AnalysisTimeline.tsx"
      via: "<AnalysisTimeline frames videoDurationSec />"
      pattern: "AnalysisTimeline"
---

<objective>
Build the MechanicsSidebar component and the /review/[videoId] page that wires all Phase 2 components together into the complete coach review workspace.

Purpose: This is the final integration point. Plans 01-04 built all the pieces — this plan assembles them into a working review workspace the coach can actually use.
Output: MechanicsSidebar component, /review/[videoId] page.
</objective>

<execution_context>
@/Users/abhishekhodavdekar/.claude/get-shit-done/workflows/execute-plan.md
@/Users/abhishekhodavdekar/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/02-ai-pose-analysis/02-CONTEXT.md
@.planning/phases/02-ai-pose-analysis/02-04-SUMMARY.md
@.planning/phases/01-foundation/01-05-SUMMARY.md

<interfaces>
<!-- From src/types/analysis.ts -->
```typescript
export type AnalysisStatus = 'pending' | 'analyzing' | 'complete' | 'error' | 'low_confidence'
export interface FrameAnalysis { frameIndex: number; timestampMs: number; landmarks: NormalizedLandmark[]; angles: FrameAngles; flags: MechanicsFlag[] }
export interface FrameAngles { elbowSlotDeg: number|null; shoulderTiltDeg: number|null; hipRotationDeg: number|null }
export interface MechanicsFlag { issue: string; confidence: number; severity: 'warning'|'error'; jointIndices: number[] }
```

<!-- From src/hooks/usePoseAnalysis.ts (Plan 04) -->
```typescript
export function usePoseAnalysis(
  videoId: string,
  videoRef: React.RefObject<HTMLVideoElement | null>
): {
  frames: FrameAnalysis[]
  analysisStatus: AnalysisStatus | null
  progressPct: number
  framingWarning: string | null
  startReanalysis: () => void
}
```

<!-- From src/components/review/* (Plan 04) -->
```typescript
// VideoWithOverlay — forwardRef
export const VideoWithOverlay = forwardRef<VideoWithOverlayHandle, {
  hlsUrl: string
  frames: FrameAnalysis[]
  showSkeleton: boolean
  onTimeUpdate?: (currentTimeSec: number) => void
}>(...)

// AnalysisTimeline
export function AnalysisTimeline(props: {
  frames: FrameAnalysis[]
  videoDurationSec: number
  currentTimeSec: number
  onSeek: (timeSec: number) => void
}): ...
```

<!-- From flags.ts (Plan 02) — ideal ranges for sidebar -->
```typescript
export const IDEAL_RANGES = {
  elbowSlot: { min: 70, max: 110 },
  shoulderTilt: { min: -20, max: 20 },
  hipRotation: { min: 75, max: 105 },
}
```

<!-- Existing app route pattern from Phase 1 -->
<!-- Server component fetches, passes to 'use client' wrapper -->
<!-- Route: src/app/(app)/dashboard/page.tsx is the model -->
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: MechanicsSidebar component</name>
  <files>src/components/review/MechanicsSidebar.tsx</files>
  <action>
Create `src/components/review/MechanicsSidebar.tsx`.

The sidebar consolidates (per CONTEXT.md decisions):
- Skeleton toggle (on/off button)
- Joint angles panel: hip rotation, elbow slot, shoulder tilt — value vs ideal range
- Active flag panel: issue label + confidence % when on a flagged frame
- Prev/Next flag navigation buttons
- Analysis status: progress bar when analyzing, framing warning callout
- Re-analyze button (disabled while status === 'analyzing')

```typescript
// src/components/review/MechanicsSidebar.tsx
'use client'

import type { FrameAnalysis, AnalysisStatus, MechanicsFlag } from '@/types/analysis'
import { IDEAL_RANGES } from '@/lib/pose/flags'

interface Props {
  currentFrame: FrameAnalysis | null
  analysisStatus: AnalysisStatus | null
  progressPct: number
  framingWarning: string | null
  showSkeleton: boolean
  onToggleSkeleton: () => void
  onStartReanalysis: () => void
  onPrevFlag: () => void
  onNextFlag: () => void
  hasPrevFlag: boolean
  hasNextFlag: boolean
  currentFlagIndex: number | null
  totalFlaggedFrames: number
}

function AngleRow({
  label,
  value,
  idealMin,
  idealMax,
  unit = '°',
}: {
  label: string
  value: number | null
  idealMin: number
  idealMax: number
  unit?: string
}) {
  if (value === null) {
    return (
      <div className="flex justify-between items-center py-1.5 border-b border-neutral-700 last:border-0">
        <span className="text-sm text-neutral-400">{label}</span>
        <span className="text-xs text-neutral-500">Low visibility</span>
      </div>
    )
  }

  const inRange = value >= idealMin && value <= idealMax
  const displayValue = Math.round(Math.abs(value))

  return (
    <div className="flex justify-between items-center py-1.5 border-b border-neutral-700 last:border-0">
      <span className="text-sm text-neutral-300">{label}</span>
      <div className="text-right">
        <span className={`text-sm font-mono font-semibold ${inRange ? 'text-emerald-400' : 'text-amber-400'}`}>
          {displayValue}{unit}
        </span>
        <span className="text-xs text-neutral-500 ml-1.5">
          ideal {idealMin}–{idealMax}{unit}
        </span>
      </div>
    </div>
  )
}

function FlagPanel({ flags }: { flags: MechanicsFlag[] }) {
  if (flags.length === 0) return (
    <p className="text-xs text-neutral-500 py-2">No mechanics issues on this frame</p>
  )

  return (
    <div className="space-y-2">
      {flags.map((flag, i) => (
        <div
          key={i}
          className={`rounded p-2 text-sm ${
            flag.severity === 'error'
              ? 'bg-red-900/40 border border-red-700'
              : 'bg-amber-900/30 border border-amber-700'
          }`}
        >
          <div className="flex justify-between">
            <span className={flag.severity === 'error' ? 'text-red-300' : 'text-amber-300'}>
              {flag.issue}
            </span>
            <span className="text-neutral-400 text-xs">
              {Math.round(flag.confidence * 100)}% confidence
            </span>
          </div>
        </div>
      ))}
    </div>
  )
}

export function MechanicsSidebar({
  currentFrame,
  analysisStatus,
  progressPct,
  framingWarning,
  showSkeleton,
  onToggleSkeleton,
  onStartReanalysis,
  onPrevFlag,
  onNextFlag,
  hasPrevFlag,
  hasNextFlag,
  currentFlagIndex,
  totalFlaggedFrames,
}: Props) {
  const isAnalyzing = analysisStatus === 'analyzing' || analysisStatus === 'pending'
  const angles = currentFrame?.angles ?? null
  const flags = currentFrame?.flags ?? []

  return (
    <aside className="w-72 bg-neutral-900 border-l border-neutral-700 p-4 flex flex-col gap-4 overflow-y-auto">

      {/* Analysis status */}
      {isAnalyzing && (
        <div>
          <div className="flex justify-between text-xs text-neutral-400 mb-1">
            <span>Analyzing…</span>
            <span>{progressPct}%</span>
          </div>
          <div className="w-full bg-neutral-700 rounded-full h-1.5">
            <div
              className="bg-blue-500 h-1.5 rounded-full transition-all duration-300"
              style={{ width: `${progressPct}%` }}
            />
          </div>
        </div>
      )}

      {/* Framing warning */}
      {framingWarning && (
        <div className="bg-amber-900/30 border border-amber-700 rounded p-2 text-xs text-amber-300">
          {framingWarning}
        </div>
      )}

      {/* Skeleton toggle */}
      <div className="flex items-center justify-between">
        <span className="text-sm text-neutral-300">Skeleton Overlay</span>
        <button
          type="button"
          onClick={onToggleSkeleton}
          className={`relative inline-flex h-5 w-9 items-center rounded-full transition-colors ${
            showSkeleton ? 'bg-blue-600' : 'bg-neutral-600'
          }`}
          aria-label={showSkeleton ? 'Hide skeleton overlay' : 'Show skeleton overlay'}
        >
          <span
            className={`inline-block h-3.5 w-3.5 transform rounded-full bg-white transition-transform ${
              showSkeleton ? 'translate-x-4' : 'translate-x-1'
            }`}
          />
        </button>
      </div>

      {/* Joint angles */}
      <section>
        <h3 className="text-xs font-semibold text-neutral-500 uppercase tracking-wider mb-2">
          Joint Angles
        </h3>
        {analysisStatus === 'complete' || analysisStatus === 'low_confidence' ? (
          <div>
            <AngleRow
              label="Hip Rotation"
              value={angles?.hipRotationDeg ?? null}
              idealMin={IDEAL_RANGES.hipRotation.min}
              idealMax={IDEAL_RANGES.hipRotation.max}
            />
            <AngleRow
              label="Elbow Slot"
              value={angles?.elbowSlotDeg ?? null}
              idealMin={IDEAL_RANGES.elbowSlot.min}
              idealMax={IDEAL_RANGES.elbowSlot.max}
            />
            <AngleRow
              label="Shoulder Tilt"
              value={angles?.shoulderTiltDeg ?? null}
              idealMin={IDEAL_RANGES.shoulderTilt.min}
              idealMax={IDEAL_RANGES.shoulderTilt.max}
            />
          </div>
        ) : (
          <p className="text-xs text-neutral-500">
            {isAnalyzing ? 'Available after analysis completes' : 'Analysis not yet run'}
          </p>
        )}
      </section>

      {/* Mechanics flags */}
      <section>
        <div className="flex items-center justify-between mb-2">
          <h3 className="text-xs font-semibold text-neutral-500 uppercase tracking-wider">
            Mechanics Issues
          </h3>
          {totalFlaggedFrames > 0 && (
            <span className="text-xs text-neutral-500">
              {currentFlagIndex !== null ? `${currentFlagIndex + 1} / ${totalFlaggedFrames}` : totalFlaggedFrames + ' flagged'}
            </span>
          )}
        </div>
        <FlagPanel flags={flags} />

        {/* Prev / Next flag navigation */}
        {totalFlaggedFrames > 0 && (
          <div className="flex gap-2 mt-2">
            <button
              type="button"
              onClick={onPrevFlag}
              disabled={!hasPrevFlag}
              className="flex-1 py-1.5 text-xs rounded bg-neutral-700 text-neutral-300 disabled:opacity-40 hover:bg-neutral-600 disabled:cursor-not-allowed transition-colors"
            >
              Prev Flag
            </button>
            <button
              type="button"
              onClick={onNextFlag}
              disabled={!hasNextFlag}
              className="flex-1 py-1.5 text-xs rounded bg-neutral-700 text-neutral-300 disabled:opacity-40 hover:bg-neutral-600 disabled:cursor-not-allowed transition-colors"
            >
              Next Flag
            </button>
          </div>
        )}
      </section>

      {/* Re-analyze */}
      <div className="mt-auto pt-4 border-t border-neutral-700">
        <button
          type="button"
          onClick={onStartReanalysis}
          disabled={isAnalyzing}
          className="w-full py-2 text-sm rounded bg-neutral-700 text-neutral-300 disabled:opacity-40 hover:bg-neutral-600 disabled:cursor-not-allowed transition-colors"
        >
          {isAnalyzing ? 'Analyzing…' : 'Re-analyze'}
        </button>
      </div>
    </aside>
  )
}
```
  </action>
  <verify>
    <automated>npx tsc --noEmit 2>&1 | head -20</automated>
  </verify>
  <done>
    - src/components/review/MechanicsSidebar.tsx exports MechanicsSidebar
    - Sidebar renders skeleton toggle, joint angles (with ideal ranges), active flags, Prev/Next navigation, progress bar, framing warning, Re-analyze button
    - Re-analyze button disabled when isAnalyzing is true
    - npx tsc --noEmit exits 0
  </done>
</task>

<task type="auto">
  <name>Task 2: /review/[videoId] review workspace page</name>
  <files>src/app/(app)/review/[videoId]/page.tsx</files>
  <action>
Create `src/app/(app)/review/[videoId]/page.tsx`.

This is a 'use client' page (needs useState/useRef/useEffect for video state management). It:
1. Fetches the video record server-side to get hlsUrl and verify coach access
2. Wires VideoWithOverlay + MechanicsSidebar + AnalysisTimeline + usePoseAnalysis into the review workspace
3. Manages skeleton toggle, current time, flagged frame navigation

Since the page needs to be a client component (for hooks and video state), use the server component + client wrapper pattern established in Phase 1 (UploadPageClient pattern):

**src/app/(app)/review/[videoId]/page.tsx** — server component that fetches video data, then renders client wrapper:

```typescript
// src/app/(app)/review/[videoId]/page.tsx
import { redirect, notFound } from 'next/navigation'
import { cookies } from 'next/headers'
import { createServerClient } from '@supabase/ssr'
import { ReviewPageClient } from '@/components/review/ReviewPageClient'

async function getVideo(videoId: string, userId: string) {
  const cookieStore = await cookies()
  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY!,
    {
      cookies: {
        getAll: () => cookieStore.getAll(),
        setAll: () => {},
      },
    }
  )

  const { data: video } = await supabase
    .from('videos')
    .select('id, title, hls_url, coach_id, athlete_id, status')
    .eq('id', videoId)
    .single()

  return video
}

export default async function ReviewPage({
  params,
}: {
  params: Promise<{ videoId: string }>
}) {
  const { videoId } = await params
  const cookieStore = await cookies()

  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY!,
    {
      cookies: {
        getAll: () => cookieStore.getAll(),
        setAll: () => {},
      },
    }
  )

  const { data: { user } } = await supabase.auth.getUser()
  if (!user) redirect('/login')

  const video = await getVideo(videoId, user.id)
  if (!video) notFound()

  // Only the coach who owns this video can access the review workspace
  if (video.coach_id !== user.id) redirect('/dashboard')

  // Video must be transcoded before analysis is possible
  if (video.status !== 'ready') {
    redirect('/dashboard')
  }

  return (
    <ReviewPageClient
      videoId={video.id}
      hlsUrl={video.hls_url as string}
      videoTitle={video.title as string | null}
    />
  )
}
```

**Also create src/components/review/ReviewPageClient.tsx** — the full client-side workspace:

```typescript
// src/components/review/ReviewPageClient.tsx
'use client'

import { useState, useRef, useCallback, useMemo } from 'react'
import { VideoWithOverlay, type VideoWithOverlayHandle } from './VideoWithOverlay'
import { MechanicsSidebar } from './MechanicsSidebar'
import { AnalysisTimeline } from './AnalysisTimeline'
import { usePoseAnalysis } from '@/hooks/usePoseAnalysis'
import type { FrameAnalysis } from '@/types/analysis'

interface Props {
  videoId: string
  hlsUrl: string
  videoTitle: string | null
}

// Find the nearest FrameAnalysis to a given time in seconds
function findFrameAtTime(frames: FrameAnalysis[], timeSec: number): FrameAnalysis | null {
  if (frames.length === 0) return null
  const timMs = timeSec * 1000
  let nearest = frames[0]
  let minDiff = Math.abs(frames[0].timestampMs - timMs)
  for (const f of frames) {
    const diff = Math.abs(f.timestampMs - timMs)
    if (diff < minDiff) { minDiff = diff; nearest = f }
  }
  return minDiff <= 300 ? nearest : null
}

export function ReviewPageClient({ videoId, hlsUrl, videoTitle }: Props) {
  const [showSkeleton, setShowSkeleton] = useState(true)
  const [currentTimeSec, setCurrentTimeSec] = useState(0)
  const [videoDurationSec, setVideoDurationSec] = useState(0)
  const [flagNavIndex, setFlagNavIndex] = useState(0)

  const overlayRef = useRef<VideoWithOverlayHandle>(null)
  const videoRef = useMemo(() => ({
    get current() { return overlayRef.current?.videoElement ?? null }
  }), [])

  const { frames, analysisStatus, progressPct, framingWarning, startReanalysis } =
    usePoseAnalysis(videoId, videoRef as React.RefObject<HTMLVideoElement | null>)

  const currentFrame = useMemo(
    () => findFrameAtTime(frames, currentTimeSec),
    [frames, currentTimeSec]
  )

  // All flagged frames sorted by timestamp
  const flaggedFrames = useMemo(
    () => frames.filter((f) => f.flags.length > 0),
    [frames]
  )

  // Find current flag index based on current time
  const currentFlagIndex = useMemo(() => {
    if (flaggedFrames.length === 0) return null
    const idx = flaggedFrames.findIndex(
      (f) => Math.abs(f.timestampMs / 1000 - currentTimeSec) <= 0.3
    )
    return idx >= 0 ? idx : null
  }, [flaggedFrames, currentTimeSec])

  const handleTimeUpdate = useCallback((timeSec: number) => {
    setCurrentTimeSec(timeSec)
    const video = overlayRef.current?.videoElement
    if (video && video.duration) setVideoDurationSec(video.duration)
  }, [])

  const handleSeek = useCallback((timeSec: number) => {
    const video = overlayRef.current?.videoElement
    if (video) video.currentTime = timeSec
  }, [])

  const handlePrevFlag = useCallback(() => {
    const idx = flagNavIndex > 0 ? flagNavIndex - 1 : 0
    setFlagNavIndex(idx)
    if (flaggedFrames[idx]) handleSeek(flaggedFrames[idx].timestampMs / 1000)
  }, [flagNavIndex, flaggedFrames, handleSeek])

  const handleNextFlag = useCallback(() => {
    const idx = Math.min(flagNavIndex + 1, flaggedFrames.length - 1)
    setFlagNavIndex(idx)
    if (flaggedFrames[idx]) handleSeek(flaggedFrames[idx].timestampMs / 1000)
  }, [flagNavIndex, flaggedFrames, handleSeek])

  return (
    <div className="flex flex-col h-screen bg-neutral-950">
      {/* Header */}
      <header className="flex items-center gap-4 px-6 py-3 border-b border-neutral-800">
        <a href="/dashboard" className="text-neutral-400 hover:text-neutral-200 text-sm">
          ← Dashboard
        </a>
        <h1 className="text-neutral-100 text-base font-medium truncate">
          {videoTitle ?? 'Review Session'}
        </h1>
      </header>

      {/* Main workspace */}
      <div className="flex flex-1 overflow-hidden">
        {/* Video + timeline */}
        <div className="flex-1 flex flex-col overflow-hidden p-4 gap-2">
          <div className="flex-1 flex items-center justify-center overflow-hidden">
            <VideoWithOverlay
              ref={overlayRef}
              hlsUrl={hlsUrl}
              frames={frames}
              showSkeleton={showSkeleton}
              onTimeUpdate={handleTimeUpdate}
            />
          </div>
          <AnalysisTimeline
            frames={frames}
            videoDurationSec={videoDurationSec}
            currentTimeSec={currentTimeSec}
            onSeek={handleSeek}
          />
        </div>

        {/* Sidebar */}
        <MechanicsSidebar
          currentFrame={currentFrame}
          analysisStatus={analysisStatus}
          progressPct={progressPct}
          framingWarning={framingWarning}
          showSkeleton={showSkeleton}
          onToggleSkeleton={() => setShowSkeleton((v) => !v)}
          onStartReanalysis={startReanalysis}
          onPrevFlag={handlePrevFlag}
          onNextFlag={handleNextFlag}
          hasPrevFlag={flagNavIndex > 0}
          hasNextFlag={flagNavIndex < flaggedFrames.length - 1}
          currentFlagIndex={currentFlagIndex}
          totalFlaggedFrames={flaggedFrames.length}
        />
      </div>
    </div>
  )
}
```

Note: ReviewPageClient.tsx is a new file not in the `files_modified` frontmatter because it was not anticipated — add it to the file list anyway. The executor should create it alongside the page.
  </action>
  <verify>
    <automated>npx tsc --noEmit 2>&1 | head -20 && npm run build 2>&1 | tail -20</automated>
  </verify>
  <done>
    - src/app/(app)/review/[videoId]/page.tsx exists (server component, fetches video, redirects on access violation)
    - src/components/review/ReviewPageClient.tsx exists (client component wiring all review components)
    - Coach can navigate to /review/[videoId] after video is ready
    - npm run build exits 0 with all routes generated
  </done>
</task>

</tasks>

<verification>
- src/components/review/MechanicsSidebar.tsx exports MechanicsSidebar
- src/app/(app)/review/[videoId]/page.tsx exists and imports ReviewPageClient
- src/components/review/ReviewPageClient.tsx wires VideoWithOverlay + MechanicsSidebar + AnalysisTimeline + usePoseAnalysis
- Re-analyze button disabled when status is 'analyzing' or 'pending'
- npm run build exits 0
</verification>

<success_criteria>
After Phase 2 Plan 05:
1. /review/[videoId] route exists, accessible only to the owning coach on ready videos
2. ReviewPageClient wires all components: video+overlay, sidebar, timeline, analysis hook
3. Joint angles update live as coach scrubs video
4. Prev/Next flag navigation seeks video to flagged frames
5. npm run build exits 0
</success_criteria>

<output>
After completion, create `.planning/phases/02-ai-pose-analysis/02-05-SUMMARY.md`
</output>
