---
phase: 01-foundation
plan: 07
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/002_optional_athlete_id.sql
  - src/app/api/upload/presign/route.ts
  - src/components/upload/VideoUploader.tsx
  - src/components/upload/UploadPageClient.tsx
autonomous: true
gap_closure: true
requirements:
  - VID-01

must_haves:
  truths:
    - "Coach can open /upload with zero active athletes and the VideoUploader renders immediately"
    - "Coach can upload a video without selecting any athlete — the upload succeeds and the video appears on /dashboard"
    - "A coach can later assign an athlete to an unassigned video (deferred assignment — future phase)"
  artifacts:
    - path: "supabase/migrations/002_optional_athlete_id.sql"
      provides: "ALTER TABLE videos ALTER COLUMN athlete_id DROP NOT NULL + updated RLS INSERT policy"
    - path: "src/app/api/upload/presign/route.ts"
      provides: "athleteId z.string().uuid().optional().nullable() — passes athlete_id: athleteId ?? null to DB"
    - path: "src/components/upload/VideoUploader.tsx"
      provides: "athleteId?: string (optional prop)"
    - path: "src/components/upload/UploadPageClient.tsx"
      provides: "canUpload gate removed — VideoUploader always renders for coaches"
  key_links:
    - from: "src/components/upload/VideoUploader.tsx"
      to: "src/app/api/upload/presign/route.ts"
      via: "fetch POST with athleteId potentially omitted"
      pattern: "athleteId.*optional"
    - from: "src/app/api/upload/presign/route.ts"
      to: "videos table"
      via: "supabase.from('videos').insert with athlete_id: null allowed"
      pattern: "athlete_id.*null"
---

<objective>
Make athlete selection optional on the upload page so coaches can upload videos without having athletes in their roster.

Purpose: The user reported that requiring athlete selection before upload is blocking — a coach should be able to upload video immediately and assign athletes later. This closes UAT test 8 by removing the gate at all three layers: DB schema (NOT NULL constraint), API route (required UUID field), and UI (canUpload gate).

Output:
- supabase/migrations/002_optional_athlete_id.sql — drops NOT NULL from videos.athlete_id, updates RLS INSERT policy
- src/app/api/upload/presign/route.ts — athleteId is now optional in Zod schema
- src/components/upload/VideoUploader.tsx — athleteId is now an optional prop
- src/components/upload/UploadPageClient.tsx — canUpload gate removed, VideoUploader always renders for coaches
</objective>

<execution_context>
@/Users/abhishekhodavdekar/.claude/get-shit-done/workflows/execute-plan.md
@/Users/abhishekhodavdekar/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-04-SUMMARY.md
@.planning/phases/01-foundation/01-05-SUMMARY.md

<interfaces>
<!-- Current presign/route.ts Zod schema — athleteId is hard required -->
```typescript
const PresignSchema = z.object({
  filename: z.string().min(1).max(255),
  contentType: z.string().regex(/^video\//),
  athleteId: z.string().uuid(),         // <-- CHANGE to .optional().nullable()
  coachId: z.string().uuid(),
})
// DB insert: { athlete_id: athleteId, ... }  <-- CHANGE to athlete_id: athleteId ?? null
```

<!-- Current VideoUploader interface — athleteId is required -->
```typescript
interface VideoUploaderProps {
  athleteId: string   // <-- CHANGE to athleteId?: string
  coachId: string
  onUploadComplete?: (videoId: string) => void
}
// In fetch body: body: JSON.stringify({ filename, contentType, athleteId, coachId })
// athleteId can now be undefined — JSON.stringify omits undefined keys, so presign receives no athleteId
// Better: explicitly send athleteId: athleteId ?? null so presign receives null (not omitted)
```

<!-- Current UploadPageClient — canUpload gate blocks VideoUploader -->
```typescript
const canUpload = !!effectiveAthleteId

// This block renders VideoUploader only when an athlete is selected:
{canUpload ? (
  <VideoUploader athleteId={effectiveAthleteId} coachId={effectiveCoachId} />
) : (
  <p className="text-sm text-gray-500">Please select an athlete above to upload a video.</p>
)}
```

<!-- Current videos table constraint (migration 001) -->
-- athlete_id UUID NOT NULL REFERENCES profiles(id)
-- RLS INSERT policy:
-- auth.uid() = uploaded_by AND (auth.uid() = coach_id OR auth.uid() = athlete_id)
-- Problem: when athlete_id IS NULL, "auth.uid() = athlete_id" is always false
-- Fix: policy should also allow when coach_id = auth.uid() AND athlete_id IS NULL
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: DB migration — make athlete_id nullable and fix RLS INSERT policy</name>
  <files>supabase/migrations/002_optional_athlete_id.sql</files>
  <action>
Create supabase/migrations/002_optional_athlete_id.sql with the following SQL:

```sql
-- Migration 002: Make athlete_id optional on videos table
-- Coaches can now upload videos without assigning an athlete (deferred assignment)

-- Drop NOT NULL constraint on athlete_id
ALTER TABLE videos ALTER COLUMN athlete_id DROP NOT NULL;

-- Replace the INSERT policy to allow null athlete_id when coach uploads
DROP POLICY IF EXISTS "videos_insert_authenticated" ON videos;

CREATE POLICY "videos_insert_authenticated" ON videos
  FOR INSERT WITH CHECK (
    auth.uid() = uploaded_by
    AND (
      -- Coach uploading for one of their athletes
      auth.uid() = coach_id
      OR
      -- Athlete uploading their own video
      auth.uid() = athlete_id
      OR
      -- Coach uploading without athlete assignment (deferred assignment)
      (auth.uid() = coach_id AND athlete_id IS NULL)
    )
  );
```

After creating the file, apply it to the Supabase database:
```bash
npx supabase db push
```

If `npx supabase db push` fails (requires linked project / running local instance), provide the SQL content as a manual step in the task output. The migration file must exist regardless.
  </action>
  <verify>ls /Users/abhishekhodavdekar/git/softball-mechanics/supabase/migrations/002_optional_athlete_id.sql</verify>
  <done>
    - supabase/migrations/002_optional_athlete_id.sql exists
    - File contains: ALTER TABLE videos ALTER COLUMN athlete_id DROP NOT NULL
    - File contains: updated INSERT policy allowing athlete_id IS NULL when coach uploads
  </done>
</task>

<task type="auto">
  <name>Task 2: Make athleteId optional in presign route, VideoUploader, and UploadPageClient</name>
  <files>
    src/app/api/upload/presign/route.ts
    src/components/upload/VideoUploader.tsx
    src/components/upload/UploadPageClient.tsx
  </files>
  <action>
**src/app/api/upload/presign/route.ts:**
- Change Zod schema: `athleteId: z.string().uuid()` → `athleteId: z.string().uuid().optional().nullable()`
- In DB insert: change `athlete_id: athleteId` → `athlete_id: athleteId ?? null`
- No other changes

**src/components/upload/VideoUploader.tsx:**
- Change interface: `athleteId: string` → `athleteId?: string`
- In the fetch body for presign: change `athleteId` → `athleteId: athleteId ?? null`
  (explicit null so the presign route receives null rather than the key being omitted)
- In the useCallback dependency array: `athleteId` stays (now possibly undefined, still valid dep)
- Comment in interface: remove "Must be provided — coach assigns athlete before uploading"
  and replace with "Optional — coach can upload without athlete assignment (deferred)"
- No other changes to upload logic, XHR flow, or queue management

**src/components/upload/UploadPageClient.tsx:**
- Remove `const canUpload = !!effectiveAthleteId` line
- Replace the conditional render block:
  ```tsx
  // BEFORE (remove):
  {canUpload ? (
    <VideoUploader athleteId={effectiveAthleteId} coachId={effectiveCoachId} />
  ) : (
    <p className="text-sm text-gray-500">Please select an athlete above to upload a video.</p>
  )}

  // AFTER:
  <VideoUploader athleteId={effectiveAthleteId || undefined} coachId={effectiveCoachId} />
  ```
- Keep the athlete dropdown UI for coaches who want to assign an athlete — just don't block upload when none is selected
- Update the "No active athletes" message to be informational only (not a blocker):
  Change "No active athletes yet. Invite one from the roster." message to remain, but render the VideoUploader below it regardless. The empty state message is now advisory, not a gate.
  ```tsx
  {isCoach && (
    <div className="mb-6">
      <label className="block text-sm font-medium text-gray-700 mb-1">
        Assign to athlete (optional)
      </label>
      {athletes.length === 0 ? (
        <p className="text-sm text-gray-500">
          No active athletes yet.{' '}
          <a href="/roster" className="text-blue-600 hover:underline">Invite one from the roster</a>{' '}
          to assign this video.
        </p>
      ) : (
        <select
          value={selectedAthleteId}
          onChange={(e) => setSelectedAthleteId(e.target.value)}
          className="w-full max-w-xs rounded-lg border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
        >
          <option value="">Unassigned</option>
          {athletes.map(a => (
            <option key={a.id} value={a.id}>{a.full_name}</option>
          ))}
        </select>
      )}
    </div>
  )}
  <VideoUploader athleteId={effectiveAthleteId || undefined} coachId={effectiveCoachId} />
  ```
  </action>
  <verify>npx tsc --noEmit && npm run build</verify>
  <done>
    - presign/route.ts: athleteId is optional/nullable in Zod, DB insert uses athlete_id: athleteId ?? null
    - VideoUploader.tsx: athleteId?: string (optional prop), sends athleteId: athleteId ?? null in presign body
    - UploadPageClient.tsx: no canUpload gate, VideoUploader always renders for coaches
    - Athlete dropdown label updated to "Assign to athlete (optional)"
    - TypeScript compiles clean (npx tsc --noEmit exits 0)
    - npm run build exits 0
  </done>
</task>

</tasks>

<verification>
1. npx tsc --noEmit exits 0
2. npm run build exits 0
3. Grep verifications:
   - supabase/migrations/002_optional_athlete_id.sql exists and contains "DROP NOT NULL"
   - presign/route.ts contains "optional()" on athleteId Zod field
   - VideoUploader.tsx athleteId prop is typed as "athleteId?: string"
   - UploadPageClient.tsx does NOT contain "canUpload"
   - UploadPageClient.tsx does NOT contain "Please select an athlete above"
</verification>

<success_criteria>
- A coach with zero roster athletes can visit /upload and see the VideoUploader immediately
- A coach can drag-drop or select a video without selecting an athlete from the dropdown
- The presign route accepts requests with null athlete_id and creates videos rows with NULL athlete_id
- TypeScript compiles clean, npm run build exits 0
- UAT test 8 can now be re-run: coach visits /upload, uploads without athlete selection, video appears on dashboard
- UAT test 9 (video upload with progress bar) is now unblocked
- UAT test 10 (transcoding complete) is now unblocked
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-07-SUMMARY.md` following the summary template.
</output>
