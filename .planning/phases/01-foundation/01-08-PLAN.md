---
phase: 01-foundation
plan: 08
type: execute
wave: 1
depends_on: []
files_modified:
  - src/middleware.ts
  - src/components/upload/VideoUploader.tsx
  - src/app/api/upload/presign/route.ts
autonomous: true
gap_closure: true
requirements: [AUTH-01, VID-01]

must_haves:
  truths:
    - "Visiting http://localhost:3000 unauthenticated redirects to /login"
    - "Coach can drag a .mov or .mkv video onto the dropzone and see a progress bar, then a Processing badge"
  artifacts:
    - path: "src/middleware.ts"
      provides: "Root route protection"
      contains: "matcher: ['/', '/((?!...)"]
    - path: "src/components/upload/VideoUploader.tsx"
      provides: "contentType fallback for empty MIME types"
      contains: "file.type || 'video/mp4'"
    - path: "src/app/api/upload/presign/route.ts"
      provides: "R2 error handling"
      contains: "try/catch"
  key_links:
    - from: "src/middleware.ts"
      to: "/login"
      via: "NextResponse.redirect on unauthenticated root visit"
      pattern: "redirect.*login"
    - from: "src/components/upload/VideoUploader.tsx"
      to: "/api/upload/presign"
      via: "fetch POST with contentType fallback"
      pattern: "file\\.type \\|\\| 'video/mp4'"
---

<objective>
Close two UAT gaps caught in re-verification: middleware never firing on bare '/' (test 1) and presign returning 400 for video formats that produce an empty file.type (test 9).

Purpose: Both failures block core user journeys — unauthenticated root visits show a coming-soon page instead of redirecting to login, and common video formats like .mov and .mkv cannot be uploaded.
Output: Patched middleware.ts, VideoUploader.tsx, and presign/route.ts — three targeted edits with no structural changes.
</objective>

<execution_context>
@/Users/abhishekhodavdekar/.claude/get-shit-done/workflows/execute-plan.md
@/Users/abhishekhodavdekar/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-UAT.md

<interfaces>
<!-- Current middleware matcher — the regex requires at least one char after the leading slash,
     so bare '/' produces an empty capture group that never matches. -->

From src/middleware.ts (current):
```typescript
export const config = {
  matcher: ['/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)'],
}
```

From src/app/api/upload/presign/route.ts (current Zod schema):
```typescript
const PresignSchema = z.object({
  filename: z.string().min(1).max(255),
  contentType: z.string().regex(/^video\//),   // Rejects empty string — causes 400 for .mov/.mkv
  athleteId: z.string().uuid().optional().nullable(),
  coachId: z.string().uuid(),
})
```

From src/components/upload/VideoUploader.tsx (current presign call):
```typescript
body: JSON.stringify({
  filename: file.name,
  contentType: file.type,     // Empty string for .mov, .mkv, .avi — fails Zod regex
  athleteId: athleteId ?? null,
  coachId,
}),
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix middleware matcher to include bare root route</name>
  <files>src/middleware.ts</files>
  <action>
    The existing matcher regex `/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)` requires at least one character after the leading slash. A bare request to `/` produces an empty capture group that does not match, so middleware never runs and the unauthenticated visitor sees the Next.js default page instead of being redirected to /login.

    Fix: Convert `matcher` from a single-entry array to a two-entry array. Add `'/'` as the first entry so the root route is matched explicitly. Keep the existing regex as the second entry unchanged — it covers all other paths.

    The result should be:
    ```typescript
    export const config = {
      matcher: [
        '/',
        '/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)',
      ],
    }
    ```

    No other changes to middleware.ts — the redirect logic and PUBLIC_PATHS handling are already correct.
  </action>
  <verify>
    Run `npx tsc --noEmit` — no TypeScript errors.
    Manually confirm: visit http://localhost:3000 in a private/incognito window (not logged in) — should redirect to /login immediately.
  </verify>
  <done>Unauthenticated visit to http://localhost:3000 redirects to /login. The coming-soon page no longer appears.</done>
</task>

<task type="auto">
  <name>Task 2: Fix contentType empty-string bug and add R2 error handling in presign route</name>
  <files>src/components/upload/VideoUploader.tsx, src/app/api/upload/presign/route.ts</files>
  <action>
    Two related changes needed:

    **VideoUploader.tsx — add contentType fallback (line 38):**
    When a user drags a .mov, .mkv, or .avi file, the browser sets file.type to an empty string. The presign route's Zod schema rejects empty string via `/^video\//` regex, returning 400, which the client surfaces as "Failed to get upload URL".

    Change line 38 in the fetch body from:
    ```typescript
    contentType: file.type,
    ```
    to:
    ```typescript
    contentType: file.type || 'video/mp4',  // Fallback for .mov/.mkv/.avi where browser omits MIME type
    ```

    Also update the XHR Content-Type header on line 53 to use the same fallback so the PUT to R2 uses the same MIME type:
    ```typescript
    xhr.setRequestHeader('Content-Type', file.type || 'video/mp4')
    ```

    **presign/route.ts — wrap getPresignedPutUrl in try/catch:**
    `getPresignedPutUrl` can throw if R2 credentials are misconfigured or the bucket is unreachable. Currently an unhandled throw crashes the route with a 500 that has no JSON body, which React error boundaries surface poorly. Wrap the call:

    ```typescript
    let presignedUrl: string
    try {
      presignedUrl = await getPresignedPutUrl(r2Key, contentType)
    } catch (r2Err) {
      console.error('[presign] R2 presign failed:', r2Err)
      return NextResponse.json({ error: 'Failed to generate upload URL' }, { status: 500 })
    }
    ```

    Remove the old single-line `const presignedUrl = await getPresignedPutUrl(r2Key, contentType)` and replace with the try/catch block above. The return statement at the bottom stays unchanged.
  </action>
  <verify>
    Run `npx tsc --noEmit` — no TypeScript errors.
    Run `npm run build` — build succeeds with no errors.
    Manual: On /upload, drag a .mov or .mkv file onto the dropzone. The progress bar should appear (not "Failed to get upload URL"). A presign 200 response is visible in browser DevTools Network tab.
  </verify>
  <done>Dragging .mov or .mkv files onto the dropzone triggers presign success (200) and the upload progress bar appears. R2 errors return a JSON 500 instead of an unhandled exception.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with no errors across all three modified files
- `npm run build` completes successfully
- Unauthenticated visit to http://localhost:3000 redirects to /login (middleware test 1)
- Dragging a .mov or .mkv video onto /upload shows progress bar instead of "Failed to get upload URL" error (UAT test 9)
</verification>

<success_criteria>
UAT tests 1 and 9 both pass:
1. Visiting http://localhost:3000 unauthenticated immediately redirects to /login
9. Dragging any video format (.mp4, .mov, .mkv, .avi) onto the dropzone produces an upload progress bar and a Processing badge after 100%
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-08-SUMMARY.md` using the summary template.
</output>
