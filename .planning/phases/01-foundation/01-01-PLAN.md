---
phase: 01-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - tsconfig.json
  - next.config.ts
  - tailwind.config.ts
  - postcss.config.mjs
  - components.json
  - .env.local.example
  - supabase/migrations/001_initial_schema.sql
autonomous: true
requirements:
  - AUTH-01
  - AUTH-02
  - AUTH-03
  - AUTH-04
  - VID-01
  - VID-02
  - ROST-01
  - ROST-02

must_haves:
  truths:
    - "A Next.js 15 App Router project exists and `npm run dev` starts without errors"
    - "All Phase 1 dependencies are installed and importable"
    - "A Supabase migration SQL file exists with profiles, coach_athletes, and videos tables with RLS enabled"
    - "An .env.local.example file documents all required environment variables"
  artifacts:
    - path: "package.json"
      provides: "Dependency manifest with all Phase 1 packages"
      contains: "@supabase/supabase-js"
    - path: "supabase/migrations/001_initial_schema.sql"
      provides: "Complete DB schema with RLS policies"
      contains: "CREATE TABLE profiles"
    - path: ".env.local.example"
      provides: "Env var documentation for all external services"
      contains: "NEXT_PUBLIC_SUPABASE_URL"
    - path: "next.config.ts"
      provides: "Next.js configuration"
  key_links:
    - from: "supabase/migrations/001_initial_schema.sql"
      to: "Supabase project"
      via: "supabase db push (run manually after Supabase project creation)"
      pattern: "CREATE TABLE profiles|CREATE TABLE coach_athletes|CREATE TABLE videos"
    - from: "package.json"
      to: "src/ source files"
      via: "npm install"
      pattern: "\"@supabase/supabase-js\"|\"inngest\"|\"ffmpeg-static\"|\"hls.js\""
---

<objective>
Bootstrap the Next.js 15 project with all Phase 1 dependencies and write the complete Supabase database schema with RLS policies. This plan produces the empty project shell and database definition that every subsequent plan builds on.

Purpose: All later plans assume a working Next.js project with dependencies installed and a known database schema. Getting this exactly right now prevents downstream rework.
Output: Runnable Next.js scaffold + migration SQL that can be pushed to a Supabase project.
</objective>

<execution_context>
@/Users/abhishekhodavdekar/.claude/get-shit-done/workflows/execute-plan.md
@/Users/abhishekhodavdekar/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scaffold Next.js 15 project and install all Phase 1 dependencies</name>
  <files>
    package.json
    tsconfig.json
    next.config.ts
    tailwind.config.ts
    postcss.config.mjs
    components.json
    .env.local.example
    src/app/layout.tsx
    src/app/page.tsx
  </files>
  <action>
Create a Next.js 15 App Router project in the current directory (not a subdirectory). Use `npx create-next-app@latest . --typescript --tailwind --eslint --app --src-dir --import-alias "@/*" --yes` to scaffold.

After scaffolding, install all Phase 1 dependencies in one command:

```bash
npm install @supabase/supabase-js @supabase/ssr inngest \
  @aws-sdk/client-s3 @aws-sdk/s3-request-presigner \
  ffmpeg-static react-dropzone hls.js \
  @tanstack/react-query zod
```

Also install shadcn/ui via CLI: `npx shadcn@latest init -d` (defaults: New York style, CSS variables). Accept defaults. This creates `components.json`.

After installation, create `.env.local.example` with all required environment variables (do NOT create `.env.local` itself — user fills in real values):

```
# Supabase
NEXT_PUBLIC_SUPABASE_URL=
NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY=

# Cloudflare R2
CF_ACCOUNT_ID=
R2_ACCESS_KEY_ID=
R2_SECRET_ACCESS_KEY=
R2_BUCKET_NAME=
R2_PUBLIC_URL=

# Inngest
INNGEST_EVENT_KEY=
INNGEST_SIGNING_KEY=

# App
NEXT_PUBLIC_APP_URL=http://localhost:3000
```

Update `next.config.ts` to allow R2 public URL in `images.remotePatterns` so Next.js Image component can serve thumbnails from R2. Use a wildcard `*.r2.dev` pattern:

```typescript
const nextConfig: NextConfig = {
  images: {
    remotePatterns: [
      { protocol: 'https', hostname: '*.r2.dev' },
    ],
  },
}
```

Replace the default `src/app/page.tsx` with a minimal placeholder:

```typescript
export default function Home() {
  return <main><p>Softball Mechanics — coming soon</p></main>
}
```

Keep `src/app/layout.tsx` as-is (Next.js default with Tailwind imports).

Do NOT add any feature code — only project setup.
  </action>
  <verify>
    <automated>cd /Users/abhishekhodavdekar/git/softball-mechanics && npm run build 2>&1 | tail -5</automated>
  </verify>
  <done>
    `npm run build` exits 0 with no TypeScript or lint errors. All packages listed in the install command are present in package.json `dependencies`. `.env.local.example` exists with all 10 env vars. `components.json` exists (shadcn initialized).
  </done>
</task>

<task type="auto">
  <name>Task 2: Write Supabase migration SQL with complete schema and RLS policies</name>
  <files>
    supabase/migrations/001_initial_schema.sql
  </files>
  <action>
Create the directory `supabase/migrations/` and write `001_initial_schema.sql` with the complete Phase 1 database schema.

The schema must implement the exact structure from 01-RESEARCH.md (Proposed Database Schema section):

```sql
-- ============================================================
-- Phase 1: Foundation Schema
-- ============================================================

-- Profiles (extends Supabase auth.users)
-- One profile per user. role is 'coach' or 'athlete'.
CREATE TABLE profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  role TEXT NOT NULL CHECK (role IN ('coach', 'athlete')),
  full_name TEXT,
  avatar_url TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Roster: many-to-many coach <-> athlete relationship
-- athlete_id is NULL until the athlete accepts their invite
CREATE TABLE coach_athletes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  coach_id UUID NOT NULL REFERENCES profiles(id),
  athlete_id UUID REFERENCES profiles(id),  -- NULL = pending invite
  athlete_email TEXT NOT NULL,
  status TEXT NOT NULL CHECK (status IN ('pending', 'active')),
  invited_at TIMESTAMPTZ DEFAULT NOW(),
  joined_at TIMESTAMPTZ
);

-- Videos
CREATE TABLE videos (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  athlete_id UUID NOT NULL REFERENCES profiles(id),
  uploaded_by UUID NOT NULL REFERENCES profiles(id),
  coach_id UUID NOT NULL REFERENCES profiles(id),
  title TEXT,
  raw_r2_key TEXT NOT NULL,
  hls_url TEXT,
  thumbnail_url TEXT,
  status TEXT NOT NULL DEFAULT 'processing'
    CHECK (status IN ('processing', 'ready', 'reviewed', 'delivered', 'error')),
  duration_seconds INTEGER,
  uploaded_at TIMESTAMPTZ DEFAULT NOW(),
  transcoded_at TIMESTAMPTZ
);

-- ============================================================
-- Row Level Security
-- ============================================================

ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE coach_athletes ENABLE ROW LEVEL SECURITY;
ALTER TABLE videos ENABLE ROW LEVEL SECURITY;

-- PROFILES policies (4 separate policies per Supabase recommendation)
CREATE POLICY "profiles_select_own" ON profiles
  FOR SELECT USING (auth.uid() = id);

CREATE POLICY "profiles_insert_own" ON profiles
  FOR INSERT WITH CHECK (auth.uid() = id);

CREATE POLICY "profiles_update_own" ON profiles
  FOR UPDATE USING (auth.uid() = id);

-- Coach can read athlete profiles (to show names in roster/dashboard)
CREATE POLICY "profiles_select_coach_athletes" ON profiles
  FOR SELECT USING (
    id IN (
      SELECT athlete_id FROM coach_athletes
      WHERE coach_id = auth.uid()
        AND athlete_id IS NOT NULL
    )
  );

-- COACH_ATHLETES policies
CREATE POLICY "coach_athletes_select_own" ON coach_athletes
  FOR SELECT USING (coach_id = auth.uid() OR athlete_id = auth.uid());

CREATE POLICY "coach_athletes_insert_coach" ON coach_athletes
  FOR INSERT WITH CHECK (coach_id = auth.uid());

CREATE POLICY "coach_athletes_update_coach" ON coach_athletes
  FOR UPDATE USING (coach_id = auth.uid());

-- VIDEOS policies
-- Coach sees videos for their athletes
CREATE POLICY "videos_select_coach" ON videos
  FOR SELECT USING (coach_id = auth.uid());

-- Athlete sees only their own videos
CREATE POLICY "videos_select_athlete" ON videos
  FOR SELECT USING (athlete_id = auth.uid());

-- Both coach and athlete can insert (athlete uploads their own; coach uploads on behalf)
CREATE POLICY "videos_insert_authenticated" ON videos
  FOR INSERT WITH CHECK (
    auth.uid() = uploaded_by
    AND (
      -- Coach uploading for one of their athletes
      auth.uid() = coach_id
      OR
      -- Athlete uploading their own video
      auth.uid() = athlete_id
    )
  );

-- Only coach can update video status (transcoding updates via service role bypass)
CREATE POLICY "videos_update_coach" ON videos
  FOR UPDATE USING (coach_id = auth.uid());

-- ============================================================
-- Trigger: auto-create profile on new user signup
-- ============================================================

CREATE OR REPLACE FUNCTION handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO profiles (id, role, full_name)
  VALUES (
    NEW.id,
    COALESCE(NEW.raw_user_meta_data->>'role', 'coach'),
    COALESCE(NEW.raw_user_meta_data->>'full_name', '')
  );
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE OR REPLACE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE FUNCTION handle_new_user();
```

Add a comment at the top of the file explaining how to apply:
```sql
-- Apply with: supabase db push
-- Or in Supabase dashboard: SQL Editor → run this file
```

NOTE: The Inngest transcodeVideo function will update `videos.status` and `videos.hls_url` using the Supabase SERVICE ROLE key (bypasses RLS). This is intentional — do NOT add an RLS policy that would allow service role to bypass while breaking the Inngest worker.
  </action>
  <verify>
    <automated>test -f /Users/abhishekhodavdekar/git/softball-mechanics/supabase/migrations/001_initial_schema.sql && grep -c "CREATE TABLE\|CREATE POLICY\|CREATE TRIGGER" /Users/abhishekhodavdekar/git/softball-mechanics/supabase/migrations/001_initial_schema.sql</automated>
  </verify>
  <done>
    File exists. `grep` count returns at least 15 (3 tables + 9+ policies + 1 trigger). All three table names (`profiles`, `coach_athletes`, `videos`) are present. `ALTER TABLE ... ENABLE ROW LEVEL SECURITY` appears 3 times. `handle_new_user` trigger function is present.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` exits 0 — no TypeScript errors in scaffold
2. `package.json` contains all 9 required packages: `@supabase/supabase-js`, `@supabase/ssr`, `inngest`, `@aws-sdk/client-s3`, `@aws-sdk/s3-request-presigner`, `ffmpeg-static`, `react-dropzone`, `hls.js`, `@tanstack/react-query`, `zod`
3. `supabase/migrations/001_initial_schema.sql` contains all 3 tables, RLS enabled on all, all policies, and the auto-create-profile trigger
4. `.env.local.example` documents all 10 required environment variables
</verification>

<success_criteria>
- `npm run build` passes with zero errors
- All Phase 1 npm packages are installed
- DB schema file is complete and ready to push to Supabase
- No auth, API, or feature code yet — this is setup only
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-01-SUMMARY.md` with:
- What was scaffolded (Next.js version, key config choices)
- All packages installed with versions (run `npm list --depth=0` and paste output)
- Schema summary (tables, RLS policy count)
- Any deviations from the plan and why
</output>
