---
phase: 01-foundation
plan: 09
type: execute
wave: 1
depends_on: []
files_modified:
  - .env.local
autonomous: false
gap_closure: true
requirements: [AUTH-02]

must_haves:
  truths:
    - "Athlete clicks the invite email link and lands on /invite/accept (not the Supabase error page)"
    - "Invite link does not produce otp_expired or access_denied error"
  artifacts:
    - path: ".env.local"
      provides: "Correct NEXT_PUBLIC_APP_URL pointing to deployed app"
      contains: "NEXT_PUBLIC_APP_URL=https://"
  key_links:
    - from: "invite email"
      to: "/auth/callback"
      via: "Supabase redirectTo built from NEXT_PUBLIC_APP_URL"
      pattern: "NEXT_PUBLIC_APP_URL"
    - from: "Supabase dashboard"
      to: "auth callback acceptance"
      via: "Redirect URLs allowlist"
      pattern: "URL Configuration > Redirect URLs"

user_setup:
  - service: supabase
    why: "Invite email redirect URLs must be in Supabase's allowlist or the OTP is rejected as access_denied"
    dashboard_config:
      - task: "Add deployed app URL to Redirect URLs allowlist"
        location: "Supabase Dashboard -> Authentication -> URL Configuration -> Redirect URLs"
        detail: "Add https://<your-deployed-domain>/auth/callback. Optionally also add http://localhost:3000/auth/callback for local dev."
      - task: "Verify Site URL is set to deployed domain (not localhost)"
        location: "Supabase Dashboard -> Authentication -> URL Configuration -> Site URL"
        detail: "Set to https://<your-deployed-domain>. This is the base URL Supabase uses when constructing email links."
---

<objective>
Close UAT gap 2: invite email links fail with otp_expired / access_denied because NEXT_PUBLIC_APP_URL is set to http://localhost:3000. Supabase rejects the localhost redirectTo URL as not in the allowed list, so the OTP is invalidated before the browser reaches /auth/callback.

Purpose: Athlete invite acceptance is entirely blocked until the app URL is correct in both the .env.local file and the Supabase dashboard allowlist. This is a configuration gap — no source code changes needed.
Output: Updated .env.local with real deployed URL, Supabase dashboard configured to allow the redirect. UAT test 6 (athlete accepts invite) becomes testable.
</objective>

<execution_context>
@/Users/abhishekhodavdekar/.claude/get-shit-done/workflows/execute-plan.md
@/Users/abhishekhodavdekar/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-UAT.md

<interfaces>
<!-- Current .env.local value causing the failure -->

From .env.local (current):
```
NEXT_PUBLIC_APP_URL=http://localhost:3000
```

The invite server action (src/lib/actions/invite.ts or similar) constructs the redirectTo URL using this value:
```typescript
const redirectTo = `${process.env.NEXT_PUBLIC_APP_URL}/auth/callback?next=/invite/accept`
```

Supabase checks the redirectTo value against its Redirect URLs allowlist before sending the email.
If the value is not in the allowlist, Supabase marks the OTP as invalid so the athlete's browser
receives error=auth_callback_failed&error_code=otp_expired.
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update NEXT_PUBLIC_APP_URL in .env.local to deployed domain</name>
  <files>.env.local</files>
  <action>
    Change the NEXT_PUBLIC_APP_URL value from `http://localhost:3000` to the real deployed app URL.

    Find the line:
    ```
    NEXT_PUBLIC_APP_URL=http://localhost:3000
    ```

    Replace with the actual deployed URL. If the app is deployed to Vercel, the URL follows the pattern `https://<project-name>.vercel.app`. If a custom domain is set, use that instead.

    Example result:
    ```
    NEXT_PUBLIC_APP_URL=https://softball-mechanics.vercel.app
    ```

    Note: If the app is not yet deployed, deploy first with `vercel --yes` and use the URL it returns. The .env.local change alone is not sufficient — the Supabase dashboard steps in the checkpoint task below are also required.

    Also update `.env.local.example` if it still shows http://localhost:3000 for this key — replace it with the pattern comment:
    ```
    NEXT_PUBLIC_APP_URL=https://your-deployed-domain.vercel.app
    ```
    If .env.local.example already shows a non-localhost placeholder, leave it unchanged.
  </action>
  <verify>
    Run: `grep NEXT_PUBLIC_APP_URL /Users/abhishekhodavdekar/git/softball-mechanics/.env.local`
    Expected: value starts with `https://` (not `http://localhost`).
  </verify>
  <done>NEXT_PUBLIC_APP_URL in .env.local is set to the real deployed HTTPS URL, not localhost.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Configure Supabase dashboard redirect URLs and verify end-to-end invite flow</name>
  <action>
    Two Supabase dashboard steps are required that cannot be automated via CLI. Complete both before testing the invite flow.

    Step 1 — Set Site URL in Supabase:
    Go to https://supabase.com/dashboard/project/tzkzqtumllirbckuohga/auth/url-configuration
    Under "Site URL", replace any localhost value with the deployed URL (e.g. https://softball-mechanics.vercel.app). Click Save.

    Step 2 — Add Redirect URLs in Supabase:
    On the same page, under "Redirect URLs", click "Add URL".
    Add: https://<your-deployed-domain>/auth/callback
    Optionally also add: http://localhost:3000/auth/callback (for local dev testing).
    Click Save.

    Step 3 — Restart the dev server so the updated .env.local is loaded:
    npm run dev

    Step 4 — Re-test invite flow (UAT test 6):
    As a coach, go to /roster and send an invite to a real email address you can access.
    Check that inbox — click the invite link.
    You should land on /invite/accept (not the Supabase error page).
    The page should redirect to /submissions.
    Back in the coach roster, the athlete's status should show "Active".
  </action>
  <verify>
    UAT test 6 end-to-end: invite link in email lands on /invite/accept without error=auth_callback_failed in the URL, then redirects to /submissions.
  </verify>
  <done>Athlete can accept invite and reach /submissions. Coach roster shows "Active" status for the athlete.</done>
  <what-built>
    NEXT_PUBLIC_APP_URL is updated in .env.local. The Supabase dashboard must now be configured to match — this requires two manual steps that cannot be automated via CLI.
  </what-built>
  <how-to-verify>
    Step 1: Go to https://supabase.com/dashboard/project/tzkzqtumllirbckuohga/auth/url-configuration
    Set Site URL to your deployed domain. Click Save.

    Step 2: Under "Redirect URLs", add https://<your-deployed-domain>/auth/callback. Click Save.

    Step 3: Restart dev server — npm run dev

    Step 4: Send a new invite from /roster, click the link in the email. Confirm you land on /invite/accept (not an error page).
  </how-to-verify>
  <resume-signal>Type "approved" if the invite flow works end-to-end, or describe the issue if it still fails</resume-signal>
</task>

</tasks>

<verification>
- .env.local NEXT_PUBLIC_APP_URL starts with https:// (not http://localhost)
- Supabase dashboard Site URL matches the deployed domain
- Supabase dashboard Redirect URLs includes https://<deployed-domain>/auth/callback
- UAT test 6: athlete clicks invite email link, lands on /invite/accept, redirects to /submissions without any error in the URL
</verification>

<success_criteria>
UAT test 6 passes:
- Athlete clicks the invite link in their email
- Browser lands on /invite/accept (no error=auth_callback_failed in URL)
- Brief loading state, then redirected to /submissions
- Coach roster shows athlete status as "Active"
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-09-SUMMARY.md` using the summary template.
</output>
