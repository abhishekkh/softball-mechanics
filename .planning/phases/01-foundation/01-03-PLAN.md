---
phase: 01-foundation
plan: 03
type: execute
wave: 3
depends_on:
  - 01-02
files_modified:
  - src/app/(auth)/login/page.tsx
  - src/app/(auth)/signup/page.tsx
  - src/app/(auth)/layout.tsx
  - src/app/auth/callback/route.ts
  - src/app/invite/[token]/page.tsx
  - src/actions/auth.ts
autonomous: true
requirements:
  - AUTH-01
  - AUTH-02
  - AUTH-03
  - AUTH-04

must_haves:
  truths:
    - "Coach can create an account with email and password and is redirected to /dashboard after signup"
    - "Coach can log in and the session persists across browser refreshes (cookie-based)"
    - "Coach can log out and is redirected to /login"
    - "Athlete receives invite email and clicking the link lands them on /invite/[token] which creates their session"
    - "Middleware correctly blocks unauthenticated access to protected routes"
  artifacts:
    - path: "src/app/(auth)/signup/page.tsx"
      provides: "Coach signup form with email + password fields"
      contains: "signUp"
    - path: "src/app/(auth)/login/page.tsx"
      provides: "Coach login form with email + password fields"
      contains: "signIn"
    - path: "src/app/auth/callback/route.ts"
      provides: "OAuth/magic-link callback handler that exchanges code for session"
      exports: ["GET"]
    - path: "src/app/invite/[token]/page.tsx"
      provides: "Athlete invite acceptance page"
      contains: "verifyOtp"
    - path: "src/actions/auth.ts"
      provides: "Server Actions for signUp, signIn, signOut, inviteAthlete"
      exports: ["signUp", "signIn", "signOut", "inviteAthlete"]
  key_links:
    - from: "src/app/(auth)/signup/page.tsx"
      to: "src/actions/auth.ts"
      via: "form action calling signUp server action"
      pattern: "action.*signUp|signUp.*formData"
    - from: "src/app/auth/callback/route.ts"
      to: "Supabase auth"
      via: "supabase.auth.exchangeCodeForSession(code)"
      pattern: "exchangeCodeForSession"
    - from: "src/app/invite/[token]/page.tsx"
      to: "Supabase auth"
      via: "supabase.auth.verifyOtp() with type: invite"
      pattern: "verifyOtp"
---

<objective>
Build the complete authentication UI and server actions: coach signup, coach login, session management, auth callback, and athlete invite acceptance. This delivers AUTH-01 through AUTH-04 — the role-separated access system the rest of the app depends on.

Purpose: Auth is gating. Without working login, no feature can be tested end-to-end.
Output: Working signup and login pages, auth callback route, athlete invite acceptance page, and all supporting server actions.
</objective>

<execution_context>
@/Users/abhishekhodavdekar/.claude/get-shit-done/workflows/execute-plan.md
@/Users/abhishekhodavdekar/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Auth server actions and callback route</name>
  <files>
    src/actions/auth.ts
    src/app/auth/callback/route.ts
  </files>
  <action>
Create the server action module and auth callback route handler.

**src/actions/auth.ts** — all auth server actions in one file:

```typescript
'use server'

import { createClient } from '@/lib/supabase/server'
import { redirect } from 'next/navigation'
import { createClient as createAdminClient } from '@supabase/supabase-js'

// Admin client for invite — uses service role key, server-only
function getAdminClient() {
  return createAdminClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!
  )
}

export async function signUp(formData: FormData) {
  const supabase = await createClient()
  const email = formData.get('email') as string
  const password = formData.get('password') as string
  const fullName = formData.get('fullName') as string

  const { error } = await supabase.auth.signUp({
    email,
    password,
    options: {
      data: { role: 'coach', full_name: fullName },
      emailRedirectTo: `${process.env.NEXT_PUBLIC_APP_URL}/auth/callback`,
    },
  })

  if (error) {
    return { error: error.message }
  }

  redirect('/dashboard')
}

export async function signIn(formData: FormData) {
  const supabase = await createClient()
  const email = formData.get('email') as string
  const password = formData.get('password') as string

  const { data, error } = await supabase.auth.signInWithPassword({ email, password })

  if (error) {
    return { error: error.message }
  }

  // Role-based redirect: coaches → /dashboard, athletes → /submissions
  const role = data.user?.user_metadata?.role ?? 'coach'
  redirect(role === 'athlete' ? '/submissions' : '/dashboard')
}

export async function signOut() {
  const supabase = await createClient()
  await supabase.auth.signOut()
  redirect('/login')
}

export async function inviteAthlete(email: string, coachId: string) {
  // Uses Supabase Admin API — inviteUserByEmail does NOT support PKCE
  // Athlete receives a magic link email; clicking it completes their signup
  const admin = getAdminClient()

  const { data, error } = await admin.auth.admin.inviteUserByEmail(email, {
    data: { role: 'athlete', invited_by: coachId },
    redirectTo: `${process.env.NEXT_PUBLIC_APP_URL}/auth/callback`,
  })

  if (error) throw error

  // Create pending coach_athletes record
  const supabase = await createClient()
  await supabase.from('coach_athletes').insert({
    coach_id: coachId,
    athlete_email: email,
    status: 'pending',
  })

  return { success: true, userId: data.user?.id }
}
```

**src/app/auth/callback/route.ts** — handles both OAuth callbacks and magic link exchanges.
This route is where Supabase redirects after email confirmation, invite acceptance, and OAuth logins:

```typescript
import { createClient } from '@/lib/supabase/server'
import { NextResponse, type NextRequest } from 'next/server'

export async function GET(request: NextRequest) {
  const { searchParams, origin } = new URL(request.url)
  const code = searchParams.get('code')
  const next = searchParams.get('next') ?? '/'

  if (code) {
    const supabase = await createClient()
    const { data, error } = await supabase.auth.exchangeCodeForSession(code)

    if (!error && data.user) {
      // Route by role after successful auth
      const role = data.user.user_metadata?.role ?? 'coach'
      const destination = role === 'athlete' ? '/submissions' : '/dashboard'
      return NextResponse.redirect(new URL(destination, origin))
    }
  }

  // Error fallback
  return NextResponse.redirect(new URL('/login?error=auth_callback_failed', origin))
}
```
  </action>
  <verify>
    <automated>cd /Users/abhishekhodavdekar/git/softball-mechanics && npx tsc --noEmit 2>&1 | head -20</automated>
  </verify>
  <done>
    `npx tsc --noEmit` exits 0. `src/actions/auth.ts` exports `signUp`, `signIn`, `signOut`, `inviteAthlete`. `src/app/auth/callback/route.ts` exports `GET` and contains `exchangeCodeForSession`. Role-based redirect logic is present in both `signIn` and the callback route.
  </done>
</task>

<task type="auto">
  <name>Task 2: Auth pages — signup, login, and athlete invite acceptance</name>
  <files>
    src/app/(auth)/layout.tsx
    src/app/(auth)/signup/page.tsx
    src/app/(auth)/login/page.tsx
    src/app/invite/[token]/page.tsx
  </files>
  <action>
Create the auth route group layout and three auth pages. Use Tailwind for styling, shadcn/ui components where appropriate.

**src/app/(auth)/layout.tsx** — centered card layout for auth pages:
```tsx
export default function AuthLayout({ children }: { children: React.ReactNode }) {
  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50">
      <div className="w-full max-w-md">
        <div className="text-center mb-8">
          <h1 className="text-2xl font-bold text-gray-900">Softball Mechanics</h1>
          <p className="text-gray-500 text-sm mt-1">Coach smarter, throw harder</p>
        </div>
        {children}
      </div>
    </div>
  )
}
```

**src/app/(auth)/signup/page.tsx** — coach registration form:
```tsx
'use client'

import { signUp } from '@/actions/auth'
import { useState } from 'react'

export default function SignUpPage() {
  const [error, setError] = useState<string | null>(null)
  const [loading, setLoading] = useState(false)

  async function handleSubmit(formData: FormData) {
    setLoading(true)
    setError(null)
    const result = await signUp(formData)
    if (result?.error) {
      setError(result.error)
      setLoading(false)
    }
    // On success, signUp redirects — no need to handle here
  }

  return (
    <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-8">
      <h2 className="text-xl font-semibold text-gray-900 mb-6">Create coach account</h2>
      <form action={handleSubmit} className="space-y-4">
        <div>
          <label htmlFor="fullName" className="block text-sm font-medium text-gray-700 mb-1">
            Full name
          </label>
          <input
            id="fullName"
            name="fullName"
            type="text"
            required
            className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
        </div>
        <div>
          <label htmlFor="email" className="block text-sm font-medium text-gray-700 mb-1">
            Email
          </label>
          <input
            id="email"
            name="email"
            type="email"
            required
            className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
        </div>
        <div>
          <label htmlFor="password" className="block text-sm font-medium text-gray-700 mb-1">
            Password
          </label>
          <input
            id="password"
            name="password"
            type="password"
            required
            minLength={8}
            className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
        </div>
        {error && (
          <p className="text-red-600 text-sm">{error}</p>
        )}
        <button
          type="submit"
          disabled={loading}
          className="w-full bg-blue-600 text-white rounded-lg py-2 text-sm font-medium hover:bg-blue-700 disabled:opacity-50 transition-colors"
        >
          {loading ? 'Creating account…' : 'Create account'}
        </button>
      </form>
      <p className="text-center text-sm text-gray-500 mt-4">
        Already have an account?{' '}
        <a href="/login" className="text-blue-600 hover:underline">Sign in</a>
      </p>
    </div>
  )
}
```

**src/app/(auth)/login/page.tsx** — coach login form:
```tsx
'use client'

import { signIn } from '@/actions/auth'
import { useState } from 'react'

export default function LoginPage() {
  const [error, setError] = useState<string | null>(null)
  const [loading, setLoading] = useState(false)

  async function handleSubmit(formData: FormData) {
    setLoading(true)
    setError(null)
    const result = await signIn(formData)
    if (result?.error) {
      setError(result.error)
      setLoading(false)
    }
  }

  return (
    <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-8">
      <h2 className="text-xl font-semibold text-gray-900 mb-6">Sign in</h2>
      <form action={handleSubmit} className="space-y-4">
        <div>
          <label htmlFor="email" className="block text-sm font-medium text-gray-700 mb-1">
            Email
          </label>
          <input
            id="email"
            name="email"
            type="email"
            required
            className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
        </div>
        <div>
          <label htmlFor="password" className="block text-sm font-medium text-gray-700 mb-1">
            Password
          </label>
          <input
            id="password"
            name="password"
            type="password"
            required
            className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
        </div>
        {error && (
          <p className="text-red-600 text-sm">{error}</p>
        )}
        <button
          type="submit"
          disabled={loading}
          className="w-full bg-blue-600 text-white rounded-lg py-2 text-sm font-medium hover:bg-blue-700 disabled:opacity-50 transition-colors"
        >
          {loading ? 'Signing in…' : 'Sign in'}
        </button>
      </form>
      <p className="text-center text-sm text-gray-500 mt-4">
        New coach?{' '}
        <a href="/signup" className="text-blue-600 hover:underline">Create account</a>
      </p>
    </div>
  )
}
```

**src/app/invite/[token]/page.tsx** — athlete invite acceptance page.
This page is hit when an athlete clicks their invite email link. The URL contains a hash-based OTP token that Supabase puts in the fragment. On the client, extract the token and call `verifyOtp`:

```tsx
'use client'

import { useEffect, useState } from 'react'
import { createClient } from '@/lib/supabase/client'
import { useRouter } from 'next/navigation'

export default function InvitePage() {
  const [status, setStatus] = useState<'loading' | 'success' | 'error'>('loading')
  const [errorMessage, setErrorMessage] = useState<string | null>(null)
  const router = useRouter()

  useEffect(() => {
    async function acceptInvite() {
      // Supabase puts the token in the URL hash (e.g., #access_token=...&type=invite)
      // Parse from window.location.hash
      const hashParams = new URLSearchParams(window.location.hash.substring(1))
      const accessToken = hashParams.get('access_token')
      const refreshToken = hashParams.get('refresh_token')
      const type = hashParams.get('type')

      if (type === 'invite' && accessToken && refreshToken) {
        const supabase = createClient()
        const { data, error } = await supabase.auth.setSession({
          access_token: accessToken,
          refresh_token: refreshToken,
        })

        if (error) {
          setErrorMessage(error.message)
          setStatus('error')
          return
        }

        // Update coach_athletes status to active
        if (data.user) {
          await supabase
            .from('coach_athletes')
            .update({ athlete_id: data.user.id, status: 'active', joined_at: new Date().toISOString() })
            .eq('athlete_email', data.user.email)
            .eq('status', 'pending')
        }

        setStatus('success')
        setTimeout(() => router.push('/submissions'), 1500)
        return
      }

      setErrorMessage('Invalid invite link. Please ask your coach to send a new invite.')
      setStatus('error')
    }

    acceptInvite()
  }, [router])

  if (status === 'loading') {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4" />
          <p className="text-gray-600">Accepting your invite…</p>
        </div>
      </div>
    )
  }

  if (status === 'success') {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="text-center">
          <p className="text-green-600 font-medium">Invite accepted! Redirecting to your submissions…</p>
        </div>
      </div>
    )
  }

  return (
    <div className="min-h-screen flex items-center justify-center">
      <div className="text-center max-w-md px-4">
        <p className="text-red-600 font-medium mb-2">Invite link error</p>
        <p className="text-gray-600 text-sm">{errorMessage}</p>
        <a href="/login" className="text-blue-600 hover:underline text-sm mt-4 block">Go to sign in</a>
      </div>
    </div>
  )
}
```

Note: The `(auth)` route group wraps login and signup pages only, not the invite page — invite page has its own centered layout inline.
  </action>
  <verify>
    <automated>cd /Users/abhishekhodavdekar/git/softball-mechanics && npx tsc --noEmit 2>&1 | head -20</automated>
  </verify>
  <done>
    `npx tsc --noEmit` exits 0. All 4 files exist. `src/app/(auth)/signup/page.tsx` and `src/app/(auth)/login/page.tsx` use `'use client'` and call their respective server actions. `src/app/invite/[token]/page.tsx` uses `setSession` to accept the invite token and updates `coach_athletes`. Auth layout provides centered card wrapper.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes clean
2. Signup form has fields: fullName, email, password; submits to `signUp` server action
3. Login form has fields: email, password; submits to `signIn` server action
4. `signIn` redirects athletes to `/submissions`, coaches to `/dashboard`
5. `auth/callback/route.ts` calls `exchangeCodeForSession` (not verifyOtp — that's for hash-based flows)
6. Invite page parses `#access_token` from URL hash and calls `supabase.auth.setSession()`
7. `inviteAthlete` server action uses admin client (service role), not browser client
</verification>

<success_criteria>
- All auth pages render without errors in `npm run dev`
- TypeScript compiles clean
- Coach can sign up → redirected to /dashboard (which will show 404 until Plan 05 — expected)
- Coach can sign in → redirected to /dashboard
- Invite acceptance flow handles the hash-based token correctly
- No hardcoded credentials or test data in any file
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-03-SUMMARY.md` with:
- Files created and their purposes
- Any TypeScript issues and resolutions
- Note on the invite flow: hash-based vs code-based (which Supabase invite type is being used)
- Confirm middleware allows /invite paths through without auth redirect
</output>
